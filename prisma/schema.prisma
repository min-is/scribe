// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Provider {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  credentials String?
  icon      String?  // Custom emoji/icon for the provider

  // Difficulty Metrics (1-10 scale)
  generalDifficulty     Int?  // Overall difficulty level for new scribes

  // Preferences
  noteTemplate String?
  noteSmartPhrase String?
  preferences  Json?      // Legacy JSON field
  wikiContent  Json?      // Rich wiki-style content (WikiContent schema)

  // Analytics
  viewCount        Int @default(0)  // Profile view tracking
  searchClickCount Int @default(0)  // Search click tracking

  // New Page relationship
  page          Page?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([viewCount])
  @@index([searchClickCount])
}

model SmartPhrase {
  id          String   @id @default(cuid())
  slug        String   @unique  // The dot phrase itself (e.g., ".PEABD")
  title       String              // Display name (e.g., "Physical Exam - Abdomen")
  category    String              // Category (e.g., "Physical Exam", "HPI", "MDM")
  description String?             // Brief description
  content     String              // Full text of the smartphrase
  tags        String[]            // Additional searchable tags

  // Analytics
  usageCount  Int      @default(0)  // Track how often it's copied

  // New Page relationship
  page          Page?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([slug])
  @@index([usageCount])
}

model Scenario {
  id          String   @id @default(cuid())
  slug        String   @unique  // URL-friendly identifier (e.g., "code-blue")
  title       String              // Display name (e.g., "Code Blue Response")
  category    String              // Category (e.g., "Emergency", "Cardiac", "Neuro")
  description String?             // Brief overview
  content     String              // Detailed walkthrough/steps in markdown or plain text
  tags        String[]            // Additional searchable tags

  // Analytics
  viewCount   Int      @default(0)  // Track how often it's viewed

  // New Page relationship
  page          Page?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([slug])
  @@index([viewCount])
}

model Procedure {
  id          String   @id @default(cuid())
  slug        String   @unique  // URL-friendly identifier (e.g., "lumbar-puncture")
  title       String              // Display name (e.g., "Lumbar Puncture")
  category    String              // Category (e.g., "Neurology", "Emergency", "ICU")
  description String?             // Brief overview
  indications String?             // When to perform this procedure
  contraindications String?       // When NOT to perform this procedure
  equipment   String?             // Required equipment/supplies
  steps       String              // Step-by-step instructions
  complications String?           // Potential complications
  tags        String[]            // Additional searchable tags

  // Analytics
  viewCount   Int      @default(0)  // Track how often it's viewed

  // New Page relationship
  page          Page?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([slug])
  @@index([viewCount])
}

// ============================================================================
// UNIFIED PAGE MODEL - Notion-like Document System
// ============================================================================

model Page {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  content       Json     // TipTap JSON content
  textContent   String?  @db.Text  // Plain text for search

  // Page Type & Hierarchy
  type          PageType // PROVIDER, PROCEDURE, SMARTPHRASE, SCENARIO, WIKI, FOLDER
  parentId      String?
  parent        Page?    @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children      Page[]   @relation("PageHierarchy")
  position      String   @default("a0")  // Fractional index for ordering

  // Visual & Metadata
  icon          String?  // Emoji or icon identifier (e.g., "ðŸ“‹", "lucide:stethoscope")
  coverPhoto    String?  // Header image URL
  category      String?  // For filtering/grouping
  tags          String[] // Searchable tags

  // Legacy compatibility - links to old models during migration
  // CASCADE delete ensures Pages are automatically deleted when source entity is deleted
  providerId           String?  @unique
  provider             Provider? @relation(fields: [providerId], references: [id], onDelete: Cascade)
  procedureId          String?  @unique
  procedure            Procedure? @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  scenarioId           String?  @unique
  scenario             Scenario? @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  smartPhraseId        String?  @unique
  smartPhrase          SmartPhrase? @relation(fields: [smartPhraseId], references: [id], onDelete: Cascade)
  physicianDirectoryId String?  @unique
  physicianDirectory   PhysicianDirectory? @relation(fields: [physicianDirectoryId], references: [id], onDelete: Cascade)
  medicationId         String?  @unique
  medication           Medication? @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  // Soft delete
  deletedAt     DateTime?

  // Analytics
  viewCount     Int      @default(0)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?

  @@index([parentId, position])
  @@index([type, deletedAt])
  @@index([slug])
  @@index([category])
}

enum PageType {
  PROVIDER
  PROCEDURE
  SMARTPHRASE
  SCENARIO
  WIKI
  FOLDER
  PHYSICIAN_DIRECTORY
  MEDICATION
}

model PhysicianDirectory {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  specialty String
  tags      String[] // For fuzzy search

  // Analytics
  viewCount Int      @default(0)

  // Page relationship
  page      Page?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([name])
  @@index([specialty])
}

model Medication {
  id              String   @id @default(cuid())
  slug            String   @unique
  name            String
  brandNames      String?  // Brand names (e.g., "Tylenol", "ProAir, Ventolin")
  type            String   // e.g., "Antibiotic", "Analgesic"
  commonlyUsedFor String?  // Description
  tags            String[] // For fuzzy search

  // Analytics
  viewCount       Int      @default(0)

  // Page relationship
  page            Page?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([name])
  @@index([type])
}

model Terminology {
  id         String   @id @default(cuid())
  slug       String   @unique
  term       String   // e.g., "BP", "HEENT"
  definition String   // Full definition
  category   String   // e.g., "Vital Signs", "Documentation"
  examples   String[] // Example usage (optional)

  // Analytics
  viewCount  Int      @default(0)

  // Metadata
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([slug])
  @@index([term])
  @@index([category])
}

model AnimatedMessage {
  id        String   @id @default(cuid())
  message   String
  order     Int      @default(0)
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([enabled])
}

model HomePageContent {
  id                    String   @id @default(cuid())
  announcementText      String   @db.Text
  gettingStartedText    String   @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Hashed password for editors
  role          UserRole  @default(EDITOR)

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  @@index([email])
  @@index([role])
}

enum UserRole {
  ADMIN
  EDITOR
}
